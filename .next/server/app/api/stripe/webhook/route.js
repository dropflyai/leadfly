"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},3255:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>v,originalPathname:()=>x,patchFetch:()=>O,requestAsyncStorage:()=>S,routeModule:()=>w,serverHooks:()=>E,staticGenerationAsyncStorage:()=>D,staticGenerationBailout:()=>k});var o={};t.r(o),t.d(o,{POST:()=>_});var i=t(884),a=t(6132),s=t(1040),n=t(5798),c=t(8888),u=t(4556);let d=new c.Z(process.env.STRIPE_SECRET_KEY),l=process.env.STRIPE_WEBHOOK_SECRET,p=(0,u.eI)("https://irvyhhkoiyzartmmvbxw.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function _(e){let r;let t=await e.text(),o=e.headers.get("stripe-signature");try{r=d.webhooks.constructEvent(t,o,l)}catch(e){return console.error("Webhook signature verification failed:",e.message),n.json({error:"Webhook signature verification failed"},{status:400})}console.log("Received Stripe webhook:",r.type);try{switch(r.type){case"customer.subscription.created":await g(r.data.object);break;case"customer.subscription.updated":await b(r.data.object);break;case"customer.subscription.deleted":await m(r.data.object);break;case"invoice.payment_succeeded":await h(r.data.object);break;case"invoice.payment_failed":await y(r.data.object);break;case"customer.created":await f(r.data.object);break;default:console.log(`Unhandled event type: ${r.type}`)}return n.json({received:!0})}catch(e){return console.error("Webhook handler error:",e),n.json({error:"Webhook handler failed"},{status:500})}}async function g(e){console.log("\uD83C\uDF89 New subscription created:",e.id);try{let r=await d.prices.retrieve(e.items.data[0].price.id);await d.products.retrieve(r.product);let t={17500:"starter",35e3:"growth",7e4:"scale",175e3:"pro",35e4:"enterprise"}[r.unit_amount]||"starter",{data:o}=await p.from("subscription_tiers").select("id").eq("slug",t).single();if(!o){console.error("Tier not found for:",t);return}let i=e.metadata.user_id,{data:a}=await p.from("profiles").select("email, onboarding_status").eq("id",i).single(),{error:s}=await p.from("user_subscriptions").upsert({user_id:i,subscription_tier_id:o.id,stripe_subscription_id:e.id,stripe_customer_id:e.customer,status:e.status,current_period_start:new Date(1e3*e.current_period_start).toISOString(),current_period_end:new Date(1e3*e.current_period_end).toISOString(),leads_used_this_period:0},{onConflict:"stripe_subscription_id"});if(s){console.error("Error creating subscription:",s);return}if(console.log("✅ Subscription created in database"),a&&"active"===e.status&&"completed"!==a.onboarding_status)try{console.log("\uD83D\uDE80 Initializing onboarding for user:",i);let r=await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/onboarding/initialize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i,email:a.email,plan_type:t,stripe_customer_id:e.customer,subscription_id:e.id})});r.ok?console.log("✅ Onboarding initialized successfully"):console.error("❌ Failed to initialize onboarding:",await r.text())}catch(e){console.error("Error initializing onboarding:",e)}}catch(e){console.error("Error handling subscription created:",e)}}async function b(e){console.log("\uD83D\uDD04 Subscription updated:",e.id);try{let{error:r}=await p.from("user_subscriptions").update({status:e.status,current_period_start:new Date(1e3*e.current_period_start).toISOString(),current_period_end:new Date(1e3*e.current_period_end).toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);r?console.error("Error updating subscription:",r):console.log("✅ Subscription updated in database")}catch(e){console.error("Error handling subscription updated:",e)}}async function m(e){console.log("❌ Subscription cancelled:",e.id);try{let{error:r}=await p.from("user_subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);r?console.error("Error cancelling subscription:",r):console.log("✅ Subscription cancelled in database")}catch(e){console.error("Error handling subscription deleted:",e)}}async function h(e){console.log("\uD83D\uDCB0 Payment succeeded:",e.id);try{if("subscription_cycle"===e.billing_reason){let{error:r}=await p.from("user_subscriptions").update({leads_used_this_period:0,updated_at:new Date().toISOString()}).eq("stripe_customer_id",e.customer);r?console.error("Error resetting lead usage:",r):console.log("✅ Lead usage reset for new billing period")}let{error:r}=await p.from("payment_logs").insert({stripe_invoice_id:e.id,stripe_customer_id:e.customer,amount:e.amount_paid,currency:e.currency,status:"succeeded",created_at:new Date().toISOString()});r&&console.error("Error logging payment:",r)}catch(e){console.error("Error handling payment succeeded:",e)}}async function y(e){console.log("\uD83D\uDCB8 Payment failed:",e.id);try{let{error:r}=await p.from("payment_logs").insert({stripe_invoice_id:e.id,stripe_customer_id:e.customer,amount:e.amount_due,currency:e.currency,status:"failed",failure_reason:"payment_failed",created_at:new Date().toISOString()});r&&console.error("Error logging failed payment:",r),console.log("⚠️ Payment failed - consider dunning management")}catch(e){console.error("Error handling payment failed:",e)}}async function f(e){console.log("\uD83D\uDC64 Customer created:",e.id);try{console.log("✅ Customer created:",e.email)}catch(e){console.error("Error handling customer created:",e)}}let w=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/rioallen/Documents/DropFly/knowledge-engine/leadfly-integration/app/api/stripe/webhook/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:S,staticGenerationAsyncStorage:D,serverHooks:E,headerHooks:v,staticGenerationBailout:k}=w,x="/api/stripe/webhook/route";function O(){return(0,s.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:D})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[271,228,851],()=>t(3255));module.exports=o})();