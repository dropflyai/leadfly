"use strict";(()=>{var e={};e.id=701,e.ids=[701],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},2089:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>f,originalPathname:()=>w,patchFetch:()=>q,requestAsyncStorage:()=>b,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>v});var s={};t.r(s),t.d(s,{GET:()=>_,POST:()=>l});var i=t(884),o=t(6132),a=t(1040),n=t(5798),u=t(8888),c=t(4556);let p=new u.Z(process.env.STRIPE_SECRET_KEY),d=(0,c.eI)("https://irvyhhkoiyzartmmvbxw.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(e){try{let r;let{user_id:t,price_id:s,user_email:i,user_name:o}=await e.json();if(!t||!s||!i)return n.json({error:"Missing required fields: user_id, price_id, user_email"},{status:400});console.log("\uD83D\uDE80 Creating subscription for user:",t);let{data:a}=await d.from("user_subscriptions").select("stripe_customer_id").eq("user_id",t).eq("status","active").single();r=a?.stripe_customer_id?await p.customers.retrieve(a.stripe_customer_id):await p.customers.create({email:i,name:o,metadata:{user_id:t}});let u=await p.prices.retrieve(s),c=await p.products.retrieve(u.product);console.log(`Creating subscription for product: ${c.name}`);let l=await p.subscriptions.create({customer:r.id,items:[{price:s}],payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],metadata:{user_id:t,leads_allowance:c.metadata.leads||"25"}}),_={17500:"starter",35e3:"growth",7e4:"scale",175e3:"pro",35e4:"enterprise"}[u.unit_amount]||"starter",{data:m}=await d.from("subscription_tiers").select("id").eq("slug",_).single();if(m){let{error:e}=await d.from("user_subscriptions").upsert({user_id:t,subscription_tier_id:m.id,stripe_subscription_id:l.id,stripe_customer_id:r.id,status:l.status,current_period_start:new Date(1e3*l.current_period_start).toISOString(),current_period_end:new Date(1e3*l.current_period_end).toISOString(),leads_used_this_period:0},{onConflict:"user_id"});e&&console.error("Database error:",e)}return n.json({subscription_id:l.id,client_secret:l.latest_invoice.payment_intent.client_secret,customer_id:r.id,status:l.status,product_name:c.name,amount:u.unit_amount,leads_allowance:c.metadata.leads})}catch(e){return console.error("Subscription creation error:",e),n.json({error:"Failed to create subscription",message:e.message},{status:500})}}async function _(e){try{let{searchParams:r}=new URL(e.url),t=r.get("user_id");if(!t)return n.json({error:"User ID required"},{status:400});let{data:s,error:i}=await d.from("user_subscriptions").select(`
        *,
        subscription_tiers (
          name,
          slug,
          monthly_price,
          monthly_leads,
          features
        )
      `).eq("user_id",t).eq("status","active").single();if(i&&"PGRST116"!==i.code)throw i;if(!s)return n.json({has_subscription:!1,subscription:null});let o=null;if(s.stripe_subscription_id)try{o=await p.subscriptions.retrieve(s.stripe_subscription_id)}catch(e){console.error("Error retrieving Stripe subscription:",e)}return n.json({has_subscription:!0,subscription:{...s,stripe_details:o}})}catch(e){return console.error("Get subscription error:",e),n.json({error:"Failed to get subscription",message:e.message},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stripe/create-subscription/route",pathname:"/api/stripe/create-subscription",filename:"route",bundlePath:"app/api/stripe/create-subscription/route"},resolvedPagePath:"/Users/rioallen/Documents/DropFly/knowledge-engine/leadfly-integration/app/api/stripe/create-subscription/route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:b,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:f,staticGenerationBailout:v}=m,w="/api/stripe/create-subscription/route";function q(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[271,228,851],()=>t(2089));module.exports=s})();